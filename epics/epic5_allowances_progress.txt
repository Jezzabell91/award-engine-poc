# Progress Log - Epic 5: Automatic Allowances

This file tracks progress across Ralph iterations. Each iteration should APPEND a new entry below.

Format:
```
## Iteration N - [TIMESTAMP]
**Task:** [User Story ID and description]
**Actions Taken:**
- [Action 1]
- [Action 2]
**Result:** [PASS/FAIL/PARTIAL]
**Notes:** [Any observations or issues]
**Commit:** [Git commit hash if applicable]
```

---

## Progress Entries

<!-- Ralph: Append your progress below this line. Do not modify entries above. -->

## Iteration 1 - 2026-01-22
**Task:** US-5.1 - Laundry Allowance - Per Shift
**Actions Taken:**
- Created `src/calculation/laundry_allowance.rs` module with:
  - `calculate_laundry_allowance()` function that checks employee tags, calculates per-shift rate, and applies weekly cap
  - `LaundryAllowanceResult` struct containing optional `AllowancePayment` and audit step
  - Constants: `LAUNDRY_ALLOWANCE_TAG` ("laundry_allowance"), `LAUNDRY_ALLOWANCE_CLAUSE` ("15.2(b)")
- Added module export to `src/calculation/mod.rs`
- Implemented all test cases:
  - LA-001: 1 shift with laundry tag → $0.32
  - LA-002: 3 shifts with laundry tag → $0.96
  - LA-003: 5 shifts hits cap → $1.49 (capped from $1.60)
  - LA-004: 6 shifts exceeds cap → $1.49 (capped from $1.92)
  - LA-005: no laundry tag → None
- Added additional edge case tests (zero shifts, other tags, casual employee)
- All audit trail includes cap application status and reasoning
**Result:** PASS
**Notes:**
- `cargo build` succeeds
- `cargo test` passes all 214 tests (12 new laundry allowance tests)
- `cargo clippy` produces no warnings
- Allowance type is "laundry", description is "Laundry Allowance" per spec

## Iteration 2 - 2026-01-22
**Task:** US-5.2 - Allowance in Calculation Result
**Actions Taken:**
- Added integration tests module to `src/calculation/laundry_allowance.rs`:
  - `test_cral_001_single_shift_with_laundry_allowance`: Full-time 8h shift with laundry tag
    - Verifies pay_lines_total = $228.32, allowances_total = $0.32, gross_pay = $228.64
  - `test_cral_002_multiple_shifts_hit_laundry_cap`: Casual 5 shifts with laundry tag
    - Verifies allowances_total = $1.49 (capped at weekly maximum)
    - Confirms cap applied correctly (5 × $0.32 = $1.60 → capped to $1.49)
  - `test_cral_003_no_allowances`: Full-time 8h shift without laundry tag
    - Verifies allowances array is empty, allowances_total = $0.00
- Added additional integration tests:
  - `test_allowances_appear_after_pay_lines`: Verifies JSON serialization order
  - `test_gross_pay_includes_pay_lines_and_allowances`: Verifies totals calculation with multiple shifts
- All tests verify:
  - CalculationResult.allowances contains applicable allowances
  - CalculationResult.totals.allowances_total equals sum of allowance amounts
  - CalculationResult.totals.gross_pay includes pay_lines + allowances
  - Audit trace includes allowance calculation steps
**Result:** PASS
**Notes:**
- `cargo build` succeeds
- `cargo test` passes all 219 tests (5 new integration tests)
- `cargo clippy` produces no warnings
- CalculationResult model already had allowances field and PayTotals.allowances_total from earlier epic
- Integration tests demonstrate correct usage of existing infrastructure

